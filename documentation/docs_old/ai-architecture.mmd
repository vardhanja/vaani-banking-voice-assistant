%% Vaani AI Module Architecture Diagram
%% Render with Mermaid CLI or compatible viewer

flowchart LR
    subgraph Client[Backend & Client]
        BE[Backend /api/chat]
        FE[Web / Voice Client]
    end

    FE --> BE
    BE --> AG[agent_graph.process_message]

    subgraph Orchestrator["Supervisor Stack (ai/orchestrator)"]
        HS[HybridSupervisor]
        CS[ConversationState]
        IR[IntentRouter]
    end

    AG --> HS
    HS --> CS
    CS --> IR
    IR --> HS

    subgraph Agents["Specialist Agents (ai/agents)"]
        BA[Banking Agent]
        UA[UPI Agent]
        RAG[RAG Supervisor]
        GR[Greeting Agent]
        FB[Feedback Agent]
    end

    HS -->|route: banking_operation| BA
    HS -->|route: upi_payment| UA
    HS -->|route: general_faq / loan_inquiry| RAG
    HS -->|route: greeting| GR
    HS -->|route: feedback| FB

    subgraph RAGSpecialists["RAG Domain Specialists (ai/agents/rag_agents)"]
        Loan[Loan Specialist]
        Invest[Investment Specialist]
        CSup[Customer Support Specialist]
    end

    RAG --> Loan
    RAG --> Invest
    RAG --> CSup

    subgraph Services["Shared Services (ai/services, ai/tools)"]
    LLM["LLMService<br/>(Ollama/OpenAI)"]
    RAGSvc["RAGService<br/>(Chroma + embeddings)"]
        Tools[Banking & UPI Tools]
    end

    BA --> LLM
    BA --> Tools
    UA --> LLM
    UA --> Tools

    Loan --> RAGSvc
    Loan --> LLM
    Invest --> RAGSvc
    Invest --> LLM
    CSup --> LLM

    RAGSvc -->|context| Loan
    RAGSvc -->|context| Invest

    GR --> HS
    FB --> HS

    BA -->|messages + structured_data + statement_data| HS
    UA -->|messages + structured_data| HS
    RAG -->|messages + structured_data| HS
    GR -->|welcome message| HS
    FB -->|acknowledgement| HS

    HS -->|final response payload| BE
    BE --> FE
