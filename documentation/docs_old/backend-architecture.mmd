%% Vaani Backend Module Architecture Diagram
%% Render with Mermaid CLI or a Mermaid-compatible viewer

flowchart LR
    subgraph Clients[User Channels]
        FE[Web Client]
        Voice[Voice UI / Assistant]
    end

    FE --> APIApp
    Voice --> APIApp

    APIApp["FastAPI App<br/>(backend/app.py)"] --> Router

    subgraph APILayer["API Layer (backend/api)"]
        Router["APIRouter /api/v1<br/>(routes.py)"]
        Context["RequestContext & Auth Guards<br/>(security.py)"]
        Schemas["Pydantic Schemas<br/>(schemas.py)"]
    end

    Router --> Context
    Router --> Schemas

    Router -->|Depends on| AuthSvc
    Router -->|Depends on| BankingSvc
    Router -->|Depends on| DeviceSvc
    Router -->|Depends on| VoiceSvc

    subgraph Services["Domain Services (backend/db/services)"]
        AuthSvc[AuthService]
        BankingSvc[BankingService]
        DeviceSvc[DeviceBindingService]
        VoiceSvc[VoiceVerificationService]
    end

    AuthSvc --> VoiceSvc
    DeviceSvc --> VoiceSvc

    subgraph Persistence["Persistence Layer (backend/db)"]
        Config["DatabaseConfig<br/>(db/config.py)"]
        Engine["SQLAlchemy Engine & Session Factory<br/>(db/engine.py)"]
        Repos["Repositories<br/>(db/repositories)"]
        Models["Models & Enums<br/>(db/models, db/utils)"]
        DB[(SQLite vaani.db)]
        Docs["Statement/Document Templates<br/>(backend/documents)"]
    end

    Config --> Engine
    Engine --> Repos
    Repos --> Models
    Models --> DB

    AuthSvc --> Engine
    BankingSvc --> Engine
    DeviceSvc --> Engine

    BankingSvc --> Docs

    Context -.-> Config
    Router -.-> Dependencies

    Dependencies["Dependency Providers<br/>(api/dependencies.py)"]
    Dependencies --> AuthSvc
    Dependencies --> BankingSvc
    Dependencies --> DeviceSvc
    Dependencies --> VoiceSvc

    Router -->|Emits responses| APIApp
    APIApp --> Clients
