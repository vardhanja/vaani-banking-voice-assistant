%% Hybrid Supervisor Architecture Diagram
%% Render with: `npx @mermaid-js/mermaid-cli -i hybrid_supervisor_architecture.mmd -o diagram.svg`
flowchart LR
    subgraph Client[Voice/Web Client]
        U(User Input)
    end

    Note right of Client: Message history (when available) stays inside the UI payload.

    subgraph SupervisorStack[Hybrid Supervisor Stack]
        CS[ConversationState Builder]
        IR[IntentRouter]
        HS[HybridSupervisor]
    end

    subgraph Specialists[Specialist Agents]
        BA[Banking Agent]
        UA[UPI Agent]
        RAG[RAG Supervisor]
        GR[Greeting Agent]
        FB[Feedback Agent]
    end

    subgraph RAGSpecialists[RAG Domain Specialists]
        Loan[Loan Specialist]
        Invest[Investment Specialist]
        CSAgent[Customer Support Specialist]
    end

    subgraph Services[Shared Services]
        LLM[LLM Service]
        Tools[Tools & Data APIs]
    end

    U --> HS
    HS --> CS
    CS --> IR
    IR --> HS
    HS -->|route key| BA
    HS -->|route key| UA
    HS -->|route key| RAG
    HS -->|route key| GR
    HS -->|route key| FB

    RAG --> Loan
    RAG --> Invest
    RAG --> CSAgent
    Loan --> RAG
    Invest --> RAG
    CSAgent --> RAG

    BA --> LLM
    BA --> Tools
    UA --> LLM
    UA --> Tools
    Loan --> LLM
    Loan --> Tools
    Invest --> LLM
    Invest --> Tools
    CSAgent --> LLM
    GR --> HS
    FB --> HS

    BA -->|structured_data / statement_data| HS
    UA -->|payment status| HS
    RAG -->|response| HS
    GR -->|welcome| HS
    FB -->|acknowledgement| HS
    HS -->|final payload| Client
