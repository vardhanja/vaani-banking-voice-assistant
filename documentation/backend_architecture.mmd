%% Backend Architecture - Clean and Aesthetic Design
%% Backend Architecture for Sun National Bank (FastAPI)
%% Vertical layout for better understanding

graph TB
    %% External Layer
    subgraph External["External Interfaces"]
        direction TB
        X01["Frontend SPA<br/>React Application"]
        X02["AI Service (Optional)<br/>AIVoiceVerification"]
    end

    %% Application Layer
    subgraph App["Application Layer"]
        direction TB
        A01["backend/app.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>create_app() returns FastAPI"]
        A02["CORS Middleware<br/>Cross-Origin Support"]
        A03["Include Router<br/>Route Registration"]
        A01 --> A02 --> A03
    end

    %% API Layer
    subgraph API["API Layer (api/)"]
        direction TB
        R01["api/routes.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>APIRouter /api/v1"]
        R02["api/dependencies.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>FastAPI Depends"]
        R03["api/security.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>RequestContext + Auth"]
        R04["api/schemas.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Pydantic Models"]
        A03 --> R01
        R01 --> R02
        R01 --> R03
        R01 -.->|"data models"| R04
    end

    %% Services Layer
    subgraph Services["Domain Services (db/services/)"]
        direction TB
        S01["AuthService<br/>Authentication & Authorization"]
        S02["BankingService<br/>Accounts · Transactions"]
        S03["DeviceBindingService<br/>Device Management"]
        S04["VoiceVerificationService<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Resemblyzer + AI-enhanced"]
        R02 -->|"Depends..."| S01
        R02 -->|"Depends..."| S02
        R02 -->|"Depends..."| S03
        R02 -->|"Depends..."| S04
        R03 -->|"validate_token"| S01
    end

    %% Repositories Layer
    subgraph Repos["Repositories (db/repositories/)"]
        direction TB
        P01["auth.py<br/>User Authentication"]
        P02["accounts.py<br/>Account Operations"]
        P03["transactions.py<br/>Transaction History"]
        P04["reminders.py<br/>Reminder Management"]
        P05["beneficiaries.py<br/>Beneficiary CRUD"]
        P06["device_bindings.py<br/>Device Storage"]
        S01 --> P01
        S02 --> P02
        S02 --> P03
        S02 --> P04
        S02 --> P05
        S03 --> P06
    end

    %% Persistence Layer
    subgraph Persistence["Persistence Layer (db/)"]
        direction TB
        D01["db/config.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>DatabaseConfig"]
        D02["db/engine.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>create_db_engine<br/>get_session_factory<br/>session_scope"]
        D03["db/base.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>SQLAlchemy Base"]
        D04["db/models/*.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>User · Account · Transaction<br/>DeviceBinding · VoiceProfile<br/>Reminder · UPIPayment"]
        D05["db/seed.py<br/>Initial Data"]
        D06[("vaani.db<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>SQLite Database")]
        R02 -->|"load_database_config"| D01
        D01 --> D02 --> D06
        D03 --> D04
        P01 --> D04
        P02 --> D04
        P03 --> D04
        P04 --> D04
        P05 --> D04
        P06 --> D04
        S01 -.->|"session_scope"| D02
        S02 -.->|"session_scope"| D02
        S03 -.->|"session_scope"| D02
    end

    %% Utilities Layer
    subgraph Utils["Utilities (db/utils/)"]
        direction TB
        U01["db/utils/enums.py<br/>Type Definitions"]
        U02["db/utils/security.py<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Password Hashing<br/>PIN Verification"]
        U03["db/utils/types.py<br/>Custom Types"]
        R01 -.->|"uses"| U01
        S01 -.->|"uses"| U02
        S02 -.->|"uses"| U01
        R01 -.->|"uses"| U02
    end

    %% External Connections
    X01 -->|"HTTP/JSON"| R01
    S04 -.->|"optional"| X02

    %% Example Flows
    %% Login Flow
    X01 -->|"POST /auth/login"| R01
    R01 -->|"/auth/login"| S01
    S01 -->|"repos + session"| P01
    P01 --> D04 --> D06

    %% Account Balance Flow
    R01 -->|"/accounts/{id}/balance"| S02
    S02 --> P02 --> D04 --> D06

    %% Transfer Flow
    R01 -->|"/transfers/internal"| S02
    S02 --> P02
    S02 --> P03

    %% UPI PIN Verify Flow
    R01 -->|"/upi/verify-pin"| S02
    R01 -->|"pin check"| U02
    S02 --> P02

    %% Styling
    classDef externalStyle fill:#4a90e2,stroke:#2c5aa0,stroke-width:2px,color:#fff
    classDef appStyle fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px,color:#fff
    classDef apiStyle fill:#51cf66,stroke:#2f9e44,stroke-width:2px,color:#fff
    classDef serviceStyle fill:#845ef7,stroke:#5f3dc4,stroke-width:2px,color:#fff
    classDef repoStyle fill:#339af0,stroke:#1971c2,stroke-width:2px,color:#fff
    classDef persistStyle fill:#20c997,stroke:#0ca678,stroke-width:2px,color:#fff
    classDef utilStyle fill:#ffa94d,stroke:#d9480f,stroke-width:2px,color:#fff

    class X01,X02 externalStyle
    class A01,A02,A03 appStyle
    class R01,R02,R03,R04 apiStyle
    class S01,S02,S03,S04 serviceStyle
    class P01,P02,P03,P04,P05,P06 repoStyle
    class D01,D02,D03,D04,D05,D06 persistStyle
    class U01,U02,U03 utilStyle
