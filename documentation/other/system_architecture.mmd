%% Vaani Banking Voice Assistant - Complete System Architecture
%% This diagram shows all three microservices and their interactions
%% Vertical layout for better understanding

graph TB
    %% User Interface Layer
    subgraph UserInterface["User Interface"]
        direction TB
        user["User<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Voice/Text Input"]
        browser["Web Browser<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>localhost:5173"]
        user --> browser
    end

    %% Frontend Layer
    subgraph FrontendLayer["Frontend Layer - React + Vite"]
        direction TB
        
        subgraph FrontendPages["Pages"]
            login["LoginPage<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Voice Auth"]
            chat["ChatPage<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Main Interface"]
            profile["ProfilePage<br/>Dashboard"]
            trans["TransactionPage<br/>History"]
        end
        
        subgraph FrontendVoice["Voice Services"]
            stt["Web Speech API<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Speech-to-Text"]
            tts["Browser TTS<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Text-to-Speech"]
        end
        
        subgraph FrontendClients["API Clients"]
            aiClient["aiClient.js<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>AI Backend Integration"]
            apiClient["api.js<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Backend API Integration"]
        end
    end

    %% Backend API Layer
    subgraph BackendAPILayer["Backend API Layer - FastAPI + SQLAlchemy"]
        direction TB
        
        subgraph BackendEndpoints["API Endpoints :8000"]
            authAPI["Auth Endpoints<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>/api/auth/*"]
            userAPI["User Endpoints<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>/api/users/*"]
            acctAPI["Account Endpoints<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>/api/accounts/*"]
            txnAPI["Transaction Endpoints<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>/api/transactions/*"]
            upiAPI["UPI Endpoints<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>/api/upi/*"]
        end
        
        subgraph BackendServices["Services"]
            userSvc["UserService<br/>User Management"]
            acctSvc["AccountService<br/>Account Operations"]
            txnSvc["TransactionService<br/>Transaction Processing"]
            voiceSvc["VoiceVerificationService<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Resemblyzer"]
            deviceSvc["DeviceBindingService<br/>Device Management"]
            upiSvc["UPIService<br/>UPI Operations"]
        end
        
        subgraph BackendDB["Database - SQLite"]
            db[("vaani.db<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>users · accounts<br/>transactions · device_bindings<br/>voice_profiles · reminders<br/>upi_payments")]
        end
    end

    %% AI Backend Layer
    subgraph AIBackendLayer["AI Backend Layer - LangGraph + Ollama"]
        direction TB
        
        subgraph AIAPI["API :8001"]
            chatAPI["POST /api/chat<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>POST /api/chat/stream<br/>GET /health"]
        end
        
        subgraph AIOrchestrator["Orchestrator"]
            supervisor["HybridSupervisor<br/>Central Coordinator"]
            router["IntentRouter<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Llama 3.2 3B"]
            state["ConversationState<br/>Context Manager"]
        end
        
        subgraph AIAgents["Agents"]
            greetAgent["Greeting Agent"]
            bankAgent["Banking Agent<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Qwen 2.5 7B"]
            upiAgent["UPI Agent<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Qwen 2.5 7B"]
            ragSuper["RAG Supervisor"]
            feedAgent["Feedback Agent"]
        end
        
        subgraph AIRAGSpecialists["RAG Specialists"]
            loanAgent["Loan Agent<br/>7 Loan Types"]
            investAgent["Investment Agent<br/>7 Schemes"]
            supportAgent["Customer Support<br/>Contact Info"]
        end
        
        subgraph AIServices["Services"]
            llmSvc["LLMService<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Ollama Integration"]
            ragSvc["RAGService<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>ChromaDB + Embeddings"]
            guardrailSvc["GuardrailService<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Input/Output Safety"]
        end
        
        subgraph AITools["Tools"]
            bankTools["Banking Tools<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>get_balance<br/>get_transactions<br/>transfer_funds<br/>reminders"]
            upiTools["UPI Tools<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>initiate_payment<br/>verify_pin<br/>check_status"]
        end
    end

    %% External Services Layer
    subgraph ExternalServices["External Services"]
        direction TB
        
        subgraph OllamaService["Ollama :11434"]
            qwen["qwen2.5:7b<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Primary Model"]
            llama["llama3.2:3b<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Fast Model"]
        end
        
        subgraph VectorDBs["Vector Databases"]
            chromaDB[("ChromaDB<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>loan_products<br/>loan_products_hindi<br/>investment_schemes<br/>investment_schemes_hindi")]
        end
        
        subgraph DocumentSources["Document Sources"]
            docs["PDF Documents<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>backend/documents/"]
        end
        
        subgraph Observability["Observability (Optional)"]
            langsmith["LangSmith<br/>━━━━━━━━━━━━━━━━━━━━━━<br/>Tracing & Metrics"]
        end
    end

    %% User Interactions
    browser --> FrontendPages
    browser --> FrontendVoice
    
    %% Frontend Voice Flow
    chat --> stt
    stt -.->|Transcribed Text| chat
    chat --> tts
    
    %% Frontend to Backend API
    login --> apiClient
    profile --> apiClient
    trans --> apiClient
    apiClient -->|HTTP| authAPI
    apiClient -->|HTTP| userAPI
    apiClient -->|HTTP| acctAPI
    apiClient -->|HTTP| txnAPI
    
    %% Frontend to AI Backend
    chat --> aiClient
    aiClient -->|HTTP| chatAPI
    
    %% AI Backend Flow
    chatAPI --> supervisor
    supervisor -->|"1. Validate Input"| guardrailSvc
    guardrailSvc -->|"Valid"| state
    guardrailSvc -->|"Blocked"| supervisor
    state --> router
    
    router -->|greeting| greetAgent
    router -->|banking| bankAgent
    router -->|upi| upiAgent
    router -->|loan/investment| ragSuper
    router -->|feedback| feedAgent
    
    ragSuper -->|loan query| loanAgent
    ragSuper -->|investment query| investAgent
    ragSuper -->|support query| supportAgent
    
    %% Agent to Services
    greetAgent --> state
    feedAgent --> state
    
    bankAgent --> llmSvc
    bankAgent --> bankTools
    
    upiAgent --> llmSvc
    upiAgent --> upiTools
    
    loanAgent --> ragSvc
    loanAgent --> llmSvc
    
    investAgent --> ragSvc
    investAgent --> llmSvc
    
    supportAgent --> llmSvc
    
    %% Tools to Backend API
    bankTools -->|HTTP Calls| acctAPI
    bankTools -->|HTTP Calls| txnAPI
    upiTools -->|HTTP Calls| upiAPI
    
    %% Services to External
    llmSvc --> qwen
    llmSvc --> llama
    ragSvc --> chromaDB
    
    %% Backend API to Database
    authAPI --> userSvc
    authAPI --> voiceSvc
    authAPI --> deviceSvc
    userAPI --> userSvc
    acctAPI --> acctSvc
    txnAPI --> txnSvc
    upiAPI --> upiSvc
    
    userSvc --> db
    acctSvc --> db
    txnSvc --> db
    voiceSvc --> db
    deviceSvc --> db
    upiSvc --> db
    
    %% RAG Document Flow
    docs -.->|Ingested| chromaDB
    
    %% Observability
    supervisor -.->|Traces| langsmith
    llmSvc -.->|Metrics| langsmith
    
    %% Response Flow Back
    supervisor -->|"2. Sanitize Output"| guardrailSvc
    guardrailSvc -->|"Sanitized"| supervisor
    supervisor -->|Response| chatAPI
    chatAPI -->|JSON| aiClient
    aiClient -->|Display| chat
    
    authAPI -->|JWT Token| apiClient
    acctAPI -->|Account Data| apiClient
    txnAPI -->|Transaction Data| apiClient
    apiClient -->|Render| profile
    apiClient -->|Render| trans

    %% Styling
    classDef frontend fill:#61dafb,stroke:#333,stroke-width:2px,color:#000
    classDef backend fill:#009688,stroke:#333,stroke-width:2px,color:#fff
    classDef ai fill:#ff6b6b,stroke:#333,stroke-width:2px,color:#fff
    classDef external fill:#ffd93d,stroke:#333,stroke-width:2px,color:#000
    classDef db fill:#4a90e2,stroke:#333,stroke-width:2px,color:#fff
    
    class login,chat,profile,trans,stt,tts,aiClient,apiClient frontend
    class authAPI,userAPI,acctAPI,txnAPI,upiAPI,userSvc,acctSvc,txnSvc,voiceSvc,deviceSvc,upiSvc backend
    class chatAPI,supervisor,router,state,greetAgent,bankAgent,upiAgent,ragSuper,feedAgent,loanAgent,investAgent,supportAgent,llmSvc,ragSvc,guardrailSvc,bankTools,upiTools ai
    class qwen,llama,docs,langsmith external
    class db,chromaDB db
